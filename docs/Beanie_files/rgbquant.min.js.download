(function(){function t(t){if(t=t||{},this.method=t.method||2,this.colors=t.colors||256,this.initColors=t.initColors||4096,this.initDist=t.initDist||.01,this.distIncr=t.distIncr||.005,this.hueGroups=t.hueGroups||10,this.satGroups=t.satGroups||10,this.lumGroups=t.lumGroups||10,this.minHueCols=t.minHueCols||0,this.hueStats=this.minHueCols?new i(this.hueGroups,this.minHueCols):null,this.boxSize=t.boxSize||[64,64],this.boxPxls=t.boxPxls||2,this.palLocked=!1,this.dithKern=t.dithKern||null,this.dithSerp=t.dithSerp||!1,this.dithDelta=t.dithDelta||0,this.histogram={},this.idxrgb=t.palette?t.palette.slice(0):[],this.idxi32=[],this.i32idx={},this.i32rgb={},this.useCache=t.useCache!==!1,this.cacheFreq=t.cacheFreq||10,this.reIndex=t.reIndex||0==this.idxrgb.length,this.colorDist="manhattan"==t.colorDist?e:s,this.idxrgb.length>0){var r=this
this.idxrgb.forEach(function(t,i){var s=(255<<24|t[2]<<16|t[1]<<8|t[0])>>>0
r.idxi32[i]=s,r.i32idx[s]=i,r.i32rgb[s]=t})}}function i(t,i){this.numGroups=t,this.minCols=i,this.stats={}
for(var r=-1;t>r;r++)this.stats[r]={num:0,cols:[]}
this.groupsFull=0}function r(t,i,r){return Math.sqrt(g*t*t+v*i*i+b*r*r)}function s(t,i){var r=i[0]-t[0],s=i[1]-t[1],e=i[2]-t[2]
return Math.sqrt(g*r*r+v*s*s+b*e*e)/S}function e(t,i){var r=Math.abs(i[0]-t[0]),s=Math.abs(i[1]-t[1]),e=Math.abs(i[2]-t[2])
return(g*r+v*s+b*e)/C}function n(t,i,s){var e,n,h,a,o,u
if(t/=255,i/=255,s/=255,e=Math.max(t,i,s),n=Math.min(t,i,s),o=(e+n)/2,e==n)h=a=0
else{switch(u=e-n,a=o>.5?u/(2-e-n):u/(e+n),e){case t:h=(i-s)/u+(s>i?6:0)
break
case i:h=(s-t)/u+2
break
case s:h=(t-i)/u+4}h/=6}return{h:h,s:a,l:r(t,i,s)}}function h(t,i){var r=1/i,s=r/2
if(t>=1-s||s>=t)return 0
for(var e=1;i>e;e++){var n=e*r
if(t>=n-s&&n+s>=t)return e}}function a(t){return t}function o(t){return t}function u(t){return Object.prototype.toString.call(t).slice(8,-1)}function l(t){var i=u(this[0])
if("Number"==i||"String"==i){for(var r,s={},e=this.length,n=0;e>n;n++)r=this[n],s[r]||0===s[r]||(s[r]=n)
return this.sort(function(i,r){return t(i,r)||s[i]-s[r]})}var s=this.map(function(t){return t})
return this.sort(function(i,r){return t(i,r)||s.indexOf(i)-s.indexOf(r)})}function c(){var t="abcdefghijklmnopqrstuvwxyz"
return"xyzvwtursopqmnklhijfgdeabc"==t.split("").sort(function(i,r){return~~(t.indexOf(r)/2.3)-~~(t.indexOf(i)/2.3)}).join("")}function d(t,i){var r,s,e,n,h,a
switch(u(t)){case"HTMLImageElement":r=document.createElement("canvas"),r.width=t.naturalWidth,r.height=t.naturalHeight,s=r.getContext("2d"),s.drawImage(t,0,0)
case"Canvas":case"HTMLCanvasElement":r=r||t,s=s||r.getContext("2d")
case"CanvasRenderingContext2D":s=s||t,r=r||s.canvas,e=s.getImageData(0,0,r.width,r.height)
case"ImageData":e=e||t,i=e.width,n="CanvasPixelArray"==u(e.data)?new Uint8Array(e.data):e.data
case"Array":case"CanvasPixelArray":n=n||new Uint8Array(t)
case"Uint8Array":case"Uint8ClampedArray":n=n||t,h=new Uint32Array(n.buffer)
case"Uint32Array":h=h||t,n=n||new Uint8Array(h.buffer),i=i||h.length,a=h.length/i}return{can:r,ctx:s,imgd:e,buf8:n,buf32:h,width:i,height:a}}function f(t,i,r,s){for(var e=t%r,n=i%s,h=t-e,a=i-n,o=[],u=0;i>u;u+=s)for(var l=0;t>l;l+=r)o.push({x:l,y:u,w:l==h?e:r,h:u==a?n:s})
return o}function x(t,i,r){var s=t,e=s.y*i+s.x,n=(s.y+s.h-1)*i+(s.x+s.w-1),h=0,a=i-s.w+1,o=e
do r.call(this,o),o+=++h%s.w==0?a:1
while(n>=o)}function p(t,i){var r=[]
for(var s in t)r.push(s)
return k.call(r,function(r,s){return i?t[s]-t[r]:t[r]-t[s]})}t.prototype.sample=function(t,i){if(this.palLocked)throw"Cannot sample additional images, palette already assembled."
var r=d(t,i)
switch(this.method){case 1:this.colorStats1D(r.buf32)
break
case 2:this.colorStats2D(r.buf32,r.width)}},t.prototype.reduce=function(t,i,r,s){if(this.palLocked||this.buildPal(),r=r||this.dithKern,s=void 0!==s?s:this.dithSerp,i=i||1,r)var e=this.dither(t,r,s)
else for(var n=d(t),h=n.buf32,a=h.length,e=new Uint32Array(a),o=0;a>o;o++){var u=h[o]
e[o]=this.nearestColor(u)}if(1==i)return new Uint8Array(e.buffer)
if(2==i){for(var l=[],a=e.length,o=0;a>o;o++){var u=e[o]
l[o]=this.i32idx[u]}return l}},t.prototype.dither=function(t,i,r){var s={FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[.25,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],Jarvis:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Burkes:[[.25,1,0],[.125,2,0],[2/32,-2,1],[.125,-1,1],[.25,0,1],[.125,1,1],[2/32,2,1]],Sierra:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[.125,-1,1],[5/32,0,1],[.125,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]],TwoSierra:[[.25,1,0],[3/16,2,0],[1/16,-2,1],[.125,-1,1],[3/16,0,1],[.125,1,1],[1/16,2,1]],SierraLite:[[.5,1,0],[.25,-1,1],[.25,0,1]]}
if(!i||!s[i])throw"Unknown dithering kernel: "+i
for(var e=s[i],n=d(t),h=n.buf32,a=n.width,o=n.height,u=(h.length,r?-1:1),l=0;o>l;l++){r&&(u=-1*u)
for(var c=l*a,f=1==u?0:a-1,x=1==u?a:0;f!==x;f+=u){var p=c+f,g=h[p],v=255&g,b=(65280&g)>>8,m=(16711680&g)>>16,y=this.nearestColor(g),w=255&y,S=(65280&y)>>8,C=(16711680&y)>>16
if(h[p]=255<<24|C<<16|S<<8|w,this.dithDelta){var k=this.colorDist([v,b,m],[w,S,C])
if(k<this.dithDelta)continue}for(var D=v-w,M=b-S,A=m-C,I=1==u?0:e.length-1,P=1==u?e.length:0;I!==P;I+=u){var F=e[I][1]*u,G=e[I][2],U=G*a
if(F+f>=0&&a>F+f&&G+l>=0&&o>G+l){var H=e[I][0],j=p+(U+F),q=255&h[j],E=(65280&h[j])>>8,L=(16711680&h[j])>>16,O=Math.max(0,Math.min(255,q+D*H)),z=Math.max(0,Math.min(255,E+M*H)),K=Math.max(0,Math.min(255,L+A*H))
h[j]=255<<24|K<<16|z<<8|O}}}}return h},t.prototype.buildPal=function(t){if(!(this.palLocked||this.idxrgb.length>0&&this.idxrgb.length<=this.colors)){var i=this.histogram,r=p(i,!0)
if(0==r.length)throw"Nothing has been sampled, palette cannot be built."
switch(this.method){case 1:for(var s=this.initColors,e=r[s-1],n=i[e],h=r.slice(0,s),a=s,o=r.length;o>a&&i[r[a]]==n;)h.push(r[a++])
this.hueStats&&this.hueStats.inject(h)
break
case 2:var h=r}h=h.map(function(t){return+t}),this.reducePal(h),!t&&this.reIndex&&this.sortPal(),this.useCache&&this.cacheHistogram(h),this.palLocked=!0}},t.prototype.palette=function(t,i){return this.buildPal(i),t?this.idxrgb:new Uint8Array(new Uint32Array(this.idxi32).buffer)},t.prototype.prunePal=function(t){for(var i,r=0;r<this.idxrgb.length;r++)t[r]||(i=this.idxi32[r],this.idxrgb[r]=null,this.idxi32[r]=null,delete this.i32idx[i])
if(this.reIndex){for(var s=[],e=[],n={},r=0,h=0;r<this.idxrgb.length;r++)this.idxrgb[r]&&(i=this.idxi32[r],s[h]=this.idxrgb[r],n[i]=h,e[h]=i,h++)
this.idxrgb=s,this.idxi32=e,this.i32idx=n}},t.prototype.reducePal=function(t){if(this.idxrgb.length>this.colors){for(var i,r=t.length,s={},e=0,n=!1,h=0;r>h;h++)e!=this.colors||n||(this.prunePal(s),n=!0),i=this.nearestIndex(t[h]),e<this.colors&&!s[i]&&(s[i]=!0,e++)
n||(this.prunePal(s),n=!0)}else{var a=t.map(function(t){return[255&t,(65280&t)>>8,(16711680&t)>>16]}),r=a.length,o=r,u=this.initDist
if(o>this.colors){for(;o>this.colors;){for(var l=[],h=0;r>h;h++){var c=a[h]
t[h]
if(c)for(var d=h+1;r>d;d++){var f=a[d],x=t[d]
if(f){var p=this.colorDist(c,f)
u>p&&(l.push([d,f,x,p]),delete a[d],o--)}}}u+=o>3*this.colors?this.initDist:this.distIncr}if(o<this.colors){k.call(l,function(t,i){return i[3]-t[3]})
for(var g=0;o<this.colors;)a[l[g][0]]=l[g][1],o++,g++}}for(var r=a.length,h=0;r>h;h++)a[h]&&(this.idxrgb.push(a[h]),this.idxi32.push(t[h]),this.i32idx[t[h]]=this.idxi32.length-1,this.i32rgb[t[h]]=a[h])}},t.prototype.colorStats1D=function(t){for(var i,r=this.histogram,s=t.length,e=0;s>e;e++)i=t[e],(4278190080&i)>>24!=0&&(this.hueStats&&this.hueStats.check(i),i in r?r[i]++:r[i]=1)},t.prototype.colorStats2D=function(t,i){var r=this.boxSize[0],s=this.boxSize[1],e=r*s,n=f(i,t.length/i,r,s),h=this.histogram,a=this
n.forEach(function(r){var s,n=Math.max(Math.round(r.w*r.h/e)*a.boxPxls,2),o={}
x(r,i,function(i){s=t[i],(4278190080&s)>>24!=0&&(a.hueStats&&a.hueStats.check(s),s in h?h[s]++:s in o?++o[s]>=n&&(h[s]=o[s]):o[s]=1)})}),this.hueStats&&this.hueStats.inject(h)},t.prototype.sortPal=function(){var t=this
this.idxi32.sort(function(i,r){var s=t.i32idx[i],e=t.i32idx[r],u=t.idxrgb[s],l=t.idxrgb[e],c=n(u[0],u[1],u[2]),d=n(l[0],l[1],l[2]),f=u[0]==u[1]&&u[1]==u[2]?-1:h(c.h,t.hueGroups),x=l[0]==l[1]&&l[1]==l[2]?-1:h(d.h,t.hueGroups),p=x-f
if(p)return-p
var g=o(+d.l.toFixed(2))-o(+c.l.toFixed(2))
if(g)return-g
var v=a(+d.s.toFixed(2))-a(+c.s.toFixed(2))
return v?-v:void 0}),this.idxi32.forEach(function(i,r){t.idxrgb[r]=t.i32rgb[i],t.i32idx[i]=r})},t.prototype.nearestColor=function(t){var i=this.nearestIndex(t)
return null===i?0:this.idxi32[i]},t.prototype.nearestIndex=function(t){if((4278190080&t)>>24==0)return null
if(this.useCache&&""+t in this.i32idx)return this.i32idx[t]
for(var i,r=1e3,s=[255&t,(65280&t)>>8,(16711680&t)>>16],e=this.idxrgb.length,n=0;e>n;n++)if(this.idxrgb[n]){var h=this.colorDist(s,this.idxrgb[n])
r>h&&(r=h,i=n)}return i},t.prototype.cacheHistogram=function(t){for(var i=0,r=t[i];i<t.length&&this.histogram[r]>=this.cacheFreq;r=t[i++])this.i32idx[r]=this.nearestIndex(r)},i.prototype.check=function(t){this.groupsFull==this.numGroups+1&&(this.check=function(){})
var i=255&t,r=(65280&t)>>8,s=(16711680&t)>>16,e=i==r&&r==s?-1:h(n(i,r,s).h,this.numGroups),a=this.stats[e],o=this.minCols
a.num++,a.num>o||(a.num==o&&this.groupsFull++,a.num<=o&&this.stats[e].cols.push(t))},i.prototype.inject=function(t){for(var i=-1;i<this.numGroups;i++)if(this.stats[i].num<=this.minCols)switch(u(t)){case"Array":this.stats[i].cols.forEach(function(i){-1==t.indexOf(i)&&t.push(i)})
break
case"Object":this.stats[i].cols.forEach(function(i){t[i]?t[i]++:t[i]=1})}}
var g=.2126,v=.7152,b=.0722,m=255,y=255,w=255,S=Math.sqrt(g*m*m+v*y*y+b*w*w),C=g*m+v*y+b*w,k=c()?Array.prototype.sort:l
this.RgbQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}).call(this)